// Generated by CoffeeScript 1.7.1
(function() {
  $(document).ready(function() {
    var SELECTED, getPMID, getSelection, iDelay, redrawTableSelection, saveSelection, study, tbl, url, url_id;
    if (!$('.selectable-table').length) {
      return;
    }
    study = document.URL.split('/').slice(-2)[0];
    url = '/studies/' + study + '/tables';
    $.get(url, function(result) {
      return window.loadImages(result.data);
    });
    tbl = $('#studies_table').dataTable({
      paginationType: "full_numbers",
      displayLength: 10,
      processing: true,
      serverSide: true,
      ajax: '/api/studies/',
      deferRender: true,
      stateSave: true,
      orderClasses: false
    });
    tbl.fnSetFilteringDelay(iDelay = 400);
    window.tbl = tbl;
    url_id = document.URL.split('/');
    url_id = url_id[url_id.length - 2];
    $('#study_features_table').dataTable({
      paginationType: "full_numbers",
      displayLength: 10,
      processing: true,
      ajax: '/api/studies/features/' + url_id + '/',
      deferRender: true,
      stateSave: true,
      order: [[1, 'desc']],
      orderClasses: false
    });
    $('#study_peaks_table').dataTable({
      paginationType: "full_numbers",
      displayLength: 10,
      processing: true,
      ajax: '/api/studies/peaks/' + url_id + '/',
      deferRender: true,
      stateSave: true,
      order: [[0, 'asc'], [2, 'asc']],
      orderClasses: false
    });
    $('#study_peaks_table').on('click', 'tr', (function(_this) {
      return function(e) {
        var data, i, row;
        row = $(e.target).closest('tr')[0];
        data = $('#study_peaks_table').dataTable().fnGetData(row);
        data = (function() {
          var _i, _len, _ref, _results;
          _ref = data.slice(1);
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            i = _ref[_i];
            _results.push(parseInt(i));
          }
          return _results;
        })();
        return viewer.moveToAtlasCoords(data);
      };
    })(this));
    SELECTED = 'info';
    getSelection = function() {
      var selection;
      return selection = JSON.parse(window.localStorage.getItem('selection') || "{}");
    };
    saveSelection = function(selection) {
      return window.localStorage.setItem('selection', JSON.stringify(selection));
    };
    getPMID = function(tr) {
      var href;
      href = $(tr).find('a').first().attr('href');
      if (href == null) {
        return null;
      }
      return /(\d+)/.exec(href)[0];
    };
    $('.selectable-table').on('click', 'tr', function() {
      var pmid, selection;
      pmid = getPMID(this);
      selection = getSelection();
      if (pmid in selection) {
        delete selection[pmid];
      } else {
        selection[pmid] = 1;
      }
      saveSelection(selection);
      return $(this).toggleClass(SELECTED);
    });
    redrawTableSelection = function() {
      var selection;
      selection = getSelection();
      return $('tbody').find('tr').each(function() {
        var pmid;
        pmid = getPMID(this);
        if (pmid in selection) {
          return $(this).addClass(SELECTED);
        } else {
          return $(this).removeClass(SELECTED);
        }
      });
    };
    $('.selectable-table').on('draw.dt', function() {
      return redrawTableSelection();
    });
    $('#select-all-btn').click(function() {
      var selection;
      selection = getSelection();
      $('tbody').find('tr').each(function() {
        var pmid;
        pmid = getPMID(this);
        return selection[pmid] = 1;
      });
      saveSelection(selection);
      return redrawTableSelection();
    });
    return $('#deselect-all-btn').click(function() {
      var selection;
      selection = getSelection();
      $('tbody').find('tr').each(function() {
        var pmid;
        pmid = getPMID(this);
        return delete selection[pmid];
      });
      saveSelection(selection);
      return redrawTableSelection();
    });
  });

}).call(this);
